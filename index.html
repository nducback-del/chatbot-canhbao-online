<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Key Generator Admin</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body { font-family: "Segoe UI", sans-serif; background:#f0f2f5; margin:0; padding:0; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
  .container { background:#fff; padding:20px; margin:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); width:400px; }
  h2 { text-align:center; margin-bottom:20px; color:#333; }
  label { display:block; margin-top:10px; font-weight:600; color:#555; }
  input, button { width:100%; padding:10px; margin-top:6px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
  button { background:#007bff; color:#fff; border:none; font-weight:600; cursor:pointer; transition:0.2s; }
  button:hover { background:#0056b3; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th, td { border:1px solid #ddd; padding:8px; text-align:center; font-size:0.9em; }
  th { background:#007bff; color:#fff; }
</style>
</head>
<body>
<div class="container">
  <h2>Admin Key Generator</h2>

  <label>Prefix (vd: KA)</label>
  <input id="prefix" value="KA">

  <label>Thời hạn (ngày)</label>
  <input id="duration" type="number" value="30">

  <label>Số máy tối đa</label>
  <input id="maxDevices" type="number" value="1">

  <label>Ghi chú (tùy chọn)</label>
  <input id="note" placeholder="Optional">

  <button id="createKeyBtn">Tạo Key</button>

  <table id="keyTable">
    <thead>
      <tr>
        <th>Key</th>
        <th>Ngày tạo</th>
        <th>Hạn</th>
        <th>Máy tối đa</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>
const API_BASE = location.origin; // đổi nếu server host khác

document.getElementById('createKeyBtn').addEventListener('click', async () => {
  const prefix = document.getElementById('prefix').value.trim();
  const durationDays = Number(document.getElementById('duration').value);
  const maxDevices = Number(document.getElementById('maxDevices').value);
  const note = document.getElementById('note').value.trim();

  try {
    const resp = await fetch(API_BASE + '/api/generate-key',{
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ prefix, durationDays, maxDevices, note })
    });

    const j = await resp.json();
    if(j.ok){
      const keyObj = j.key;
      // copy key tự động
      const tmp = document.createElement('input');
      document.body.appendChild(tmp);
      tmp.value = keyObj.key;
      tmp.select();
      document.execCommand('copy');
      document.body.removeChild(tmp);
      alert("✅ Key tạo xong và đã copy clipboard!");

      // thêm vào bảng
      const tbody = document.querySelector('#keyTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${keyObj.key}</td><td>${new Date(keyObj.createdAt).toLocaleDateString()}</td>
                      <td>${new Date(keyObj.expiresAt).toLocaleDateString()}</td><td>${keyObj.maxDevices}</td>`;
      tbody.prepend(tr);
    } else {
      alert("❌ Lỗi tạo key: " + JSON.stringify(j));
    }
  } catch(err){
    alert("❌ Lỗi kết nối server: " + err.message);
  }
});
</script>
</body>
</html>